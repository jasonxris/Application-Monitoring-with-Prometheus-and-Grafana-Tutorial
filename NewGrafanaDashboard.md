# Create a New Grafana Dashboard


## Import a New Dashboard for Minecraft

_A Grafana dashboard is how Grafana displays the data. We are going to import a pre-made dashboard._

1. **Create a New dashboard** by clicking &quot;New dashboard&quot;

![](RackMultipart20200425-4-1dxjp97_html_abdde373fc8f6e19.png)

1. **Open the dashboard menu** by clicking the top left menu button and **select Import Dashboard**

![](RackMultipart20200425-4-1dxjp97_html_627dd6564f0632b5.png) ![](RackMultipart20200425-4-1dxjp97_html_a03ce844d4bd6255.png)

1. **Copy and Paste in the JSON text** found in this file: [https://drive.google.com/file/d/1MlHd9b5RCwo7kIdPT1SCEAXDbDiYWycE/view?usp=sharing](https://drive.google.com/file/d/1MlHd9b5RCwo7kIdPT1SCEAXDbDiYWycE/view?usp=sharing)

![](RackMultipart20200425-4-1dxjp97_html_df761d6e8964abe0.png)

1. Click -\&gt; Load
2. Click -\&gt; Import
3. Your dashboard should now look like the screenshot below:

![](RackMultipart20200425-4-1dxjp97_html_20b81363c4601a63.png)

1. This Grafana dashboard is now showing data that is being generated by your Minecraft server. Not a lot is happening on this dashboard. That is because not a lot is changing or happening on your Minecraft server.
  1. _(optional)_ If you have a Minecraft account, you can log in to your localhost server and interact with the server to get more interesting data
2. Compare the Grafana displays to the data being scraped from the Minecraft server at: [http://localhost:9225/metrics](http://localhost:9225/metrics)

## Create a New Entities Dashboard Panel for Minecraft

_You will now create your own Grafana dashboard. This dashboard will display the total number of Minecraft entities on your Minecraft server, and the total number of living Minecraft entities on your server. The data is already being collected by Prometheus and can be seen at_ [_http://localhost:9225/metrics_](http://localhost:9225/metrics) _as mc\_entities\_total and mc\_living\_entities\_total._

1. Click on the **Create New Panel** Button

![](RackMultipart20200425-4-1dxjp97_html_90d6ebb77e53dcf1.png)

1. Click **Add Query**

![](RackMultipart20200425-4-1dxjp97_html_94664c6ce0501822.png)

1. **Change Query** from default **to the name you gave your Prometheus Data Source, the default name is : Prometheus**
2. Select the metrics field and fill in mc\_ to see all the Minecraft metrics available
3. Select the mc\_entities\_total
4. We are now going to add another query to display on this panel.
5. **Click on the Add Query** button found in the panel menu, as shown in the screenshot below.

![](RackMultipart20200425-4-1dxjp97_html_62beda725f6729fe.png)

1. In the second Query field that was created , **type in mc\_living\_entities\_total**
2. **Click on the General tab** on the left and **change the title of the panel** from &quot;Panel Title&quot; to &quot;Entities&quot;

![](RackMultipart20200425-4-1dxjp97_html_467a65b2369fd214.png)

1. Click on your browser&#39;s back button to see the dashboard reflecting the changes you have made.
2. If everything is being imported correctly, the dashboard should look like the screenshot below

![](RackMultipart20200425-4-1dxjp97_html_cb33bb38b46c64e9.png)

_This dashboard is displaying more than just two sets of data. This is because mc\_living\_total has several subsections. By querying for mc\_living\_total, you are asking for_ _ **all** _ _of the mc\_living\_total data available._

## Clean up the Panel Key

_At this point you have a dashboard that displays the entities data, but the panel is not very clear. We are going to edit it to make the graph easier to read._

1. **Select the Entities panel** you just created
2. **Click Edit**
3. Each metric has identifiers as seen in the screenshot below:

![](RackMultipart20200425-4-1dxjp97_html_b8d7c2b77869255a.png)

  1. For this metric there are three
    1. **Instance:** identifies which IP address this metric is from
    2. **Job :** identifies which Prometheus job this metric is from
    3. **World :** identifies which Minecraft world this metric is from
1. We can use these identifiers in the dashboard&#39;s legend to make reading the data easier to read. We are going to use the world identifier.
2. Add **{{world}}** into the **legends** field in both the mc\_living\_entitied and mc\_entities\_total query.
  1. This will remove all the extra information in the dashboards legend. Showing only the world that the information is coming from.
3. Now we need to differentiate the living entities from the total entities
4. Replace _{{world}}_ with _{{world}}\_total_ in the mc\_entities\_total query&#39;s legend field.
5. Replace _{{world}}_ with _{{world}}_\_living in the mc\_living\_entities\_total query&#39;s legend field .
6. Back out and save the dashboard
7. **Take a screenshot of your whole dashboard to turn in**

## When Finished

After you have completed this tutorial:

1. Stop your Minecraft server, you will no longer need it
  1. You can do this by typing the following command into your minecraft terminal : _stop_
  2. Keep track of the dashboard screenshot to be turned in later
2. **Complete the Lab found below**

# Lab

Application Monitoring with Prometheus and Grafana

## Introduction

While there are many exporters that automatically collect data from certain programs, exporters will not always collect the data you want or be available at all. **Instrumenting is how you can manually expose data** you want to Prometheus.

The program that you will instrument today is a very simple server. It runs a binary search tree that randomly adds and deletes a value every second. Even though you probably will not encounter a server like this one in the workforce, it will provide a simplified environment to practice exposing data to Prometheus.

## The Lab

**Create a new Maven IntelliJ project**. Then download the source files found at the link below and place the .java files in the src folder of your IntelliJ project.

**Source Files:** [https://drive.google.com/file/d/1CiKD3vPLbD-PKH4XS3M1EufPXwH7tOkp/view?usp=sharing](https://drive.google.com/file/d/1CiKD3vPLbD-PKH4XS3M1EufPXwH7tOkp/view?usp=sharing)

**Main.java**

- The main method:
  - Runs the algorithm in a background thread
  - Creates an HTPPServer which is a Prometheus exporter
  - Runs the server on a port

- The Main.java has a single counter metric defined as an example to follow.
- Make sure to read comments in the Main.java file to understand how the different functions work.

**Dependencies**

- **Add the dependencies and maven compiler plugin** that are found in the link below to your pom file:

[https://docs.google.com/document/d/1UsHdoW6hyX2yJexgFwRV4Z5g4p9n44L4kSXseFQRCDE/edit?usp=sharing](https://docs.google.com/document/d/1UsHdoW6hyX2yJexgFwRV4Z5g4p9n44L4kSXseFQRCDE/edit?usp=sharing)

- The maven compiler plugin sets the java language level to 8
- The dependencies allow you to expose data in a format that Prometheus can read

**BST, BSTNode, and FailedRemoveException**

- These are the classes of the Binary Search Tree that the main method will be using.
- **DO NOT MODIFY**
- You do not need to touch these files to instrument your code.

**Configure Prometheus:**

1. **Stop Prometheus**
2. **Update your prometheus.yml** to make Prometheus scrapes data from your server .

  1. Copy and paste the scrape\_config text below **over the old scrape config** in your prometheus.yml

_scrape\_configs:_

_# The job name is added as a label `job=\&lt;job_name\&gt;` to any timeseries scraped from this config._

_- job\_name: &#39;prometheus&#39;_

_static\_configs:_

_- targets: [&#39;localhost:9090&#39;]_

_- job\_name: &#39;minecraft&#39;_

_static\_configs:_

_- targets: [&#39;localhost:9225&#39;]_

_- job\_name: &#39;javaSever&#39;_

_static\_configs:_

_- targets: [&#39;localhost:8080&#39;]_

1. **Start Prometheus** again
  1. use the following command to run prometheus
    1. Mac: **prometheus --config.file=\&lt;directory for your config file\&gt;/prometheus.yml**
    2. Windows: Run the prometheus.exe file

## Requirements

You are to instrument the given server to display the data given below. Then take a screenshot of the Grafana dashboard displaying the information scraped from the running server.

1. **Instrument the Main.java file**

_Instrumenting Java code is done by creating a metric object and then using this metric object to increment, decrement, keep track of a timer, or keep track of anything else the metric is capable of doing. By creating and registering the metric object, the data it collects becomes viewable by the Prometheus Server when your server is running._

- The specific metrics and java code you will need to instrument the server is described in the Prometheus Java Guide in the link below: [https://docs.google.com/document/d/1lTysUo1-1vW8Epqyx6LKSEl9vd9Ns4dSd5dC\_guTdUs/edit?usp=sharing](https://docs.google.com/document/d/1lTysUo1-1vW8Epqyx6LKSEl9vd9Ns4dSd5dC_guTdUs/edit?usp=sharing)

- The example metric is there to show you how a counter is initialized and how it is used to keep track of the number of times the server runs through its thread. It can be ignored or deleted.

The data you will need to collect for this Lab is shown below:

1. Count the number of failed removes **(use Counter Metric)**

    - Increment a counter when the server fails to remove a number for any reason

1. Count the number of failed adds **(use Counter metric)**

    - Increment a counter when the server fails to add a number for any reason

1. Keep track of the number of nodes currently on the Server **(use Gauge metric)**

    - Describes the number of BST nodes currently on the server

1. Measure the amount of time it takes for the BST add method to run **(use Summary Metric)**

    - You will have to use a timer to measure how long it takes for the add method to run.

To verify your instrumentation, navigate to [http://localhost:8080/metrics](http://localhost:8080/metrics)

    - This page will display the raw data being collected by Prometheus from port 8080.
    - **Note:** Data will only be collected while your server is running

**2. Display the data you gather in your Main.java file on a Grafana Dashboard**

Once the data is being collected, you will create your own Grafana Dashboard with panels to display the data you collect.

**Create a new Grafana Dashboard**

1. On the left menu of Grafana, **Click the plus symbol,** then **Click &quot;Dashboard&quot;** from the menu displayed by the Plus Symbol
  1. This will create a new empty Dashboard. We will be adding 4 panels to this dashboard.

**Create**** Four Grafana Panels** that displays the following information about the server:

1. The total number of failed removes **(use Counter Metric)**

1. The total number of failed adds **(use Counter metric)**

1. The number of nodes currently on the Server **(use Gauge metric)**

    - Use a Gauge Grafana visual to display this data

- Follow the picture guide at the bottom of this document if you don&#39;t know how to use a Gauge Visual

1. The average duration of the BST add method**(use Summary Metric)**

    - In your Main.java instrumentation, you kept track of the time it took to iterate through the add function. Using prometheus query expressions, we can use the data collected to get the average duration.
    - **The section below explains how to use a Prometheus query expression to calculate the values for this panel**

At the end your Grafana Panels should look similar to the screenshot below

![](RackMultipart20200425-4-1dxjp97_html_1b4216e6aaa1a510.png)

To expose the data gathered by your metrics to Prometheus, **run the main method** found in the Main.java file. Your server will then expose data gathered by the metric objects you created. Prometheus will then be able to collect this data from localhost:8080.

**3. Take a screenshot of the Grafana Dashboard you created**

## How to get Average Rate from a Prometheus Query

1. To display the Average duration of the add function you will use the Prometheus Query Function: Rate.

![](RackMultipart20200425-4-1dxjp97_html_1ad334bb5dbb8881.png)

1. A summary metric has a few different parts that can be pulled out.
  1. Adding &quot;\_sum&quot; to the end of your summary metric query gets the sum of the observations
  2. Adding &quot;\_count&quot; to the end of your summary metric query gets the number of observations
2. In Grafana, this is done by placing the metric within the rate function in the Query field of the dashboard. ![](RackMultipart20200425-4-1dxjp97_html_37006e0d46abebcc.png)

##


##


## What to turn in

To receive credit for the lab, turn in:

- **Your modified Main.java**
- **1 screenshot of your Minecraft Grafana Dashboard**
- **1 screenshot of your working Java server Grafana Dashboard**

## Hints

- Make sure your Prometheus.yml is configured to target your Intellj server and collect data from it
- Use [http://localhost:9090/targets](http://localhost:9090/targets) to make sure that your server&#39;sdata is being collected
- Use [http://localhost:8080/metrics](http://localhost:8080/metrics) to see what your defined metrics look like
- **If you change or add a Metric in your java program, make sure to update the DataSource on Grafana to get updated metrics.**
  - You do this by going to Configure -\&gt; Data Source -\&gt; Your\_Data\_Source -\&gt; Save &amp; Test. This is shown in screenshots below
- If Grafana doesn&#39;t seem to be displaying your data, refresh the data by making Grafana display the last 5 minutes of data.

### How to Change the Visualization of A Panel (in Dashboard Edit menu)

![](RackMultipart20200425-4-1dxjp97_html_f631a34e4ff056ef.png)

### How to Change Grafana Time Range

![](RackMultipart20200425-4-1dxjp97_html_95d180cd130298f4.png)

16
